# Fastfile - Fastlane Configuration for Android
# https://docs.fastlane.tools

default_platform(:android)

# Configure Android SDK paths
android_home = ENV["ANDROID_HOME"] || File.expand_path("~/Library/Android/sdk")
ENV["ANDROID_HOME"] = android_home
ENV["PATH"] = "#{android_home}/platform-tools:#{android_home}/emulator:#{ENV['PATH']}"

platform :android do
  desc "Generate localized screenshots for Play Store and website"
  lane :screenshots do
    adb = "#{ENV['ANDROID_HOME']}/platform-tools/adb"

    # Build the app and test APKs
    gradle(
      task: "assembleDebug assembleAndroidTest"
    )

    # Install APKs (screengrab reinstall can be unreliable)
    sh("#{adb} install -r ../app/build/outputs/apk/debug/app-debug.apk")
    sh("#{adb} install -r ../app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk")

    # Capture screenshots for all locales
    capture_android_screenshots

    # Rename screenshots folder for Supply
    # Screengrab writes to: metadata/android/<locale>/images/screenshots/*.png
    # Supply expects: metadata/android/<locale>/images/phoneScreenshots/*.png
    Dir.glob("metadata/android/*/images/screenshots").each do |dir|
      target = dir.gsub("/screenshots", "/phoneScreenshots")
      FileUtils.rm_rf(target) if File.exist?(target)
      FileUtils.mv(dir, target)
    end

    UI.success("Screenshots generated successfully!")
    UI.message("Output: fastlane/metadata/android/*/images/phoneScreenshots/")
  end

  desc "Validate screenshot setup (quick check)"
  lane :screenshot_validate do
    gradle(
      task: "assembleDebug assembleAndroidTest"
    )
    UI.success("Screenshot APKs built successfully!")
  end

  # =============================================================================
  # Release Lanes
  # =============================================================================

  desc "Upload to Play Store (Closed Testing by default)"
  lane :release do |options|
    track = options[:track] || "alpha"  # alpha = Closed Testing

    UI.message("Building release bundle...")
    gradle(
      task: "bundleRelease"
    )

    UI.message("Uploading to Play Store (#{track})...")
    supply(
      track: track,
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_apk: true,
      skip_upload_metadata: false,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: false
    )

    UI.success("Release uploaded to #{track} track!")
  end

  desc "Validate release without uploading (dry run)"
  lane :release_dry do
    UI.message("Building release bundle...")
    gradle(
      task: "bundleRelease"
    )

    UI.message("Validating Play Store configuration...")
    supply(
      track: "alpha",
      aab: "app/build/outputs/bundle/release/app-release.aab",
      skip_upload_apk: true,
      validate_only: true
    )

    UI.success("Validation successful! Ready for release.")
  end

  desc "Upload only screenshots without new build"
  lane :screenshots_upload do |options|
    track = options[:track] || "alpha"  # alpha = Closed Testing
    UI.message("Uploading screenshots to Play Store (track: #{track})...")

    upload_to_play_store(
      track: track,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: true,
      skip_upload_images: true,
      skip_upload_screenshots: false,
      sync_image_upload: true,
      version_code: options[:version_code]
    )

    UI.success("Screenshots uploaded!")
  end

  desc "Upload only metadata (descriptions, changelogs) without new build"
  lane :metadata do |options|
    track = options[:track] || "alpha"  # alpha = Closed Testing
    UI.message("Uploading metadata to Play Store (track: #{track})...")
    supply(
      track: track,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    UI.success("Metadata updated!")
  end

  desc "Upload to Production (requires confirmation)"
  lane :release_production do
    UI.important("You are about to release to PRODUCTION!")
    UI.important("This will make the app available to all users.")

    if UI.confirm("Are you sure you want to release to production?")
      release(track: "production")
    else
      UI.user_error!("Release cancelled.")
    end
  end
end
