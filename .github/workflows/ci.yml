name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

# Cancel outdated runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '26.0'
  IOS_VERSION: '18.4'
  DEVICE: 'iPhone 16 Plus'

jobs:
  lint:
    name: Code Quality (SwiftLint + SwiftFormat)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Cache Homebrew
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Cellar/swiftlint
          /usr/local/Cellar/swiftformat
        key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          ${{ runner.os }}-brew-

    - name: Install SwiftLint
      run: |
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi
        swiftlint version

    - name: Install SwiftFormat
      run: |
        if ! command -v swiftformat &> /dev/null; then
          brew install swiftformat
        fi
        swiftformat --version

    - name: Run SwiftFormat Check
      run: make format || swiftformat --lint .

    - name: Run SwiftLint
      run: make lint

  build-and-test:
    name: Build & Unit Tests
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Setup Local Configuration
      run: |
        # Create Local.xcconfig from template for CI
        # CI doesn't need a real Team ID since we disable code signing
        cp Config/Local.xcconfig.example Config/Local.xcconfig
        # Replace placeholder with dummy value (CI uses CODE_SIGNING_REQUIRED=NO)
        sed -i '' 's/YOUR_TEAM_ID/CI_BUILD/' Config/Local.xcconfig
        echo "✅ Created Local.xcconfig for CI build"

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Developer/Xcode/DerivedData/ModuleCache.noindex
        key: ${{ runner.os }}-derived-${{ hashFiles('**/*.swift', '**/*.m', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-derived-

    - name: Cache SPM Dependencies
      uses: actions/cache@v4
      with:
        path: |
          .build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Run Unit Tests with Coverage
      run: make test-unit

    - name: Generate Coverage Report
      if: always()
      run: |
        if [ -d "TestResults.xcresult" ]; then
          make test-report
        else
          echo "⚠️ No test results found, skipping report"
        fi

    - name: Upload Coverage Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: |
          coverage.txt
          TestResults.xcresult
        retention-days: 30

    - name: Upload Coverage for Comment
      uses: actions/upload-artifact@v4
      if: github.event_name == 'pull_request'
      with:
        name: coverage-data
        path: |
          TestResults.xcresult
        retention-days: 7

  ui-tests:
    name: UI Tests
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Setup Local Configuration
      run: |
        # Create Local.xcconfig from template for CI
        # CI doesn't need a real Team ID since we disable code signing
        cp Config/Local.xcconfig.example Config/Local.xcconfig
        # Replace placeholder with dummy value (CI uses CODE_SIGNING_REQUIRED=NO)
        sed -i '' 's/YOUR_TEAM_ID/CI_BUILD/' Config/Local.xcconfig
        echo "✅ Created Local.xcconfig for CI build"

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-derived-ui-${{ hashFiles('**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-derived-ui-
          ${{ runner.os }}-derived-

    - name: Reset Simulator
      run: make simulator-reset

    - name: Run UI Tests
      run: make test-ui

    - name: Upload UI Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-failures
        path: |
          ~/Library/Logs/DiagnosticReports/
          TestResults.xcresult
        retention-days: 7

  static-analysis:
    name: Static Analysis (Xcode Analyzer)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Setup Local Configuration
      run: |
        # Create Local.xcconfig from template for CI
        # CI doesn't need a real Team ID since we disable code signing
        cp Config/Local.xcconfig.example Config/Local.xcconfig
        # Replace placeholder with dummy value (CI uses CODE_SIGNING_REQUIRED=NO)
        sed -i '' 's/YOUR_TEAM_ID/CI_BUILD/' Config/Local.xcconfig
        echo "✅ Created Local.xcconfig for CI build"

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-analyze-${{ hashFiles('**/*.swift', '**/*.m', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-analyze-

    - name: Run Xcode Static Analysis
      run: |
        xcodebuild analyze \
          -project StillMoment.xcodeproj \
          -scheme StillMoment \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee analyze-output.log

        # Check for analyzer warnings
        if grep -q "warning:" analyze-output.log; then
          echo "❌ Static analysis found warnings:"
          grep "warning:" analyze-output.log
          exit 1
        else
          echo "✅ No static analysis warnings found"
        fi

    - name: Upload Analysis Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-results
        path: analyze-output.log
        retention-days: 7
