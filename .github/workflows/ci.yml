name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

# Cancel outdated runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  XCODE_VERSION: '26.0'
  IOS_VERSION: '19.0'
  DEVICE: 'iPhone 17'

jobs:
  lint:
    name: Code Quality (SwiftLint + SwiftFormat)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Cache Homebrew
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Caches/Homebrew
          /usr/local/Cellar/swiftlint
          /usr/local/Cellar/swiftformat
        key: ${{ runner.os }}-brew-${{ hashFiles('.github/workflows/ci.yml') }}
        restore-keys: |
          ${{ runner.os }}-brew-

    - name: Install SwiftLint
      run: |
        if ! command -v swiftlint &> /dev/null; then
          brew install swiftlint
        fi
        swiftlint version

    - name: Install SwiftFormat
      run: |
        if ! command -v swiftformat &> /dev/null; then
          brew install swiftformat
        fi
        swiftformat --version

    - name: Run SwiftFormat Check
      run: cd ios && make format

    - name: Run SwiftLint
      run: cd ios && make lint

  build-and-test:
    name: Build & Unit Tests
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Show Xcode Version
      run: xcodebuild -version

    - name: Setup Local Configuration
      run: |
        # Create Local.xcconfig from template for CI
        # CI doesn't need a real Team ID since we disable code signing
        cp ios/Config/Local.xcconfig.example ios/Config/Local.xcconfig
        # Replace placeholder with dummy value (CI uses CODE_SIGNING_REQUIRED=NO)
        sed -i '' 's/YOUR_TEAM_ID/CI_BUILD/' ios/Config/Local.xcconfig
        echo "‚úÖ Created Local.xcconfig for CI build"

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Developer/Xcode/DerivedData/ModuleCache.noindex
        key: ${{ runner.os }}-derived-${{ hashFiles('ios/**/*.swift', 'ios/**/*.m', 'ios/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-derived-

    - name: Cache SPM Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ios/.build
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('ios/**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Run Unit Tests
      run: cd ios && make test-unit

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: unit-test-failures
        path: ios/TestResults.xcresult
        retention-days: 7

  ui-tests:
    name: UI Tests
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Setup Local Configuration
      run: |
        # Create Local.xcconfig from template for CI
        # CI doesn't need a real Team ID since we disable code signing
        cp ios/Config/Local.xcconfig.example ios/Config/Local.xcconfig
        # Replace placeholder with dummy value (CI uses CODE_SIGNING_REQUIRED=NO)
        sed -i '' 's/YOUR_TEAM_ID/CI_BUILD/' ios/Config/Local.xcconfig
        echo "‚úÖ Created Local.xcconfig for CI build"

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-derived-ui-${{ hashFiles('ios/**/*.swift') }}
        restore-keys: |
          ${{ runner.os }}-derived-ui-
          ${{ runner.os }}-derived-

    - name: Reset Simulator
      run: cd ios && make simulator-reset

    - name: Warm up Simulator
      run: |
        # Boot simulator and let it settle
        echo "üîß Booting simulator..."
        DEVICE_ID=$(xcrun simctl list devices available | grep "${{ env.DEVICE }}" | grep -v "unavailable" | head -1 | sed -E 's/.*\(([A-Z0-9-]+)\).*/\1/')

        if [ -z "$DEVICE_ID" ]; then
          echo "‚ùå Error: Could not find device matching '${{ env.DEVICE }}'"
          exit 1
        fi

        echo "üì± Using device ID: $DEVICE_ID"
        xcrun simctl boot "$DEVICE_ID" || true

        # Wait for simulator to be fully booted
        echo "‚è≥ Waiting for simulator to be ready..."
        for i in {1..30}; do
          if xcrun simctl list devices | grep "$DEVICE_ID" | grep -q "Booted"; then
            echo "‚úÖ Simulator is booted"
            break
          fi
          sleep 1
        done

        # Give simulator extra time to settle
        echo "‚è≥ Letting simulator settle (15 seconds)..."
        sleep 15

        echo "‚úÖ Simulator warmup complete"

    - name: Run UI Tests
      timeout-minutes: 20
      run: cd ios && make test-ui

    - name: Upload UI Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: ui-test-failures
        path: |
          ~/Library/Logs/DiagnosticReports/
          ios/TestResults.xcresult
        retention-days: 7

  static-analysis:
    name: Static Analysis (Xcode Analyzer)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Setup Local Configuration
      run: |
        # Create Local.xcconfig from template for CI
        # CI doesn't need a real Team ID since we disable code signing
        cp ios/Config/Local.xcconfig.example ios/Config/Local.xcconfig
        # Replace placeholder with dummy value (CI uses CODE_SIGNING_REQUIRED=NO)
        sed -i '' 's/YOUR_TEAM_ID/CI_BUILD/' ios/Config/Local.xcconfig
        echo "‚úÖ Created Local.xcconfig for CI build"

    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-analyze-${{ hashFiles('ios/**/*.swift', 'ios/**/*.m', 'ios/**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-analyze-

    - name: Run Xcode Static Analysis
      run: |
        xcodebuild analyze \
          -project ios/StillMoment.xcodeproj \
          -scheme StillMoment \
          -destination "platform=iOS Simulator,name=${{ env.DEVICE }},OS=${{ env.IOS_VERSION }}" \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          | tee analyze-output.log

        # Check for analyzer warnings
        if grep -q "warning:" analyze-output.log; then
          echo "‚ùå Static analysis found warnings:"
          grep "warning:" analyze-output.log
          exit 1
        else
          echo "‚úÖ No static analysis warnings found"
        fi

    - name: Upload Analysis Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: static-analysis-results
        path: analyze-output.log
        retention-days: 7

  # ===================
  # Android Jobs
  # ===================

  android-code-quality:
    name: Android Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Run Code Quality Checks
      run: cd android && ./gradlew ktlintCheck lint detekt

    - name: Upload Quality Reports
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: android-quality-reports
        path: |
          android/app/build/reports/lint-results*.html
          android/app/build/reports/ktlint/
          android/app/build/reports/detekt/
        retention-days: 7

  android-build-and-test:
    name: Android Build & Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*', 'android/**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build Debug APK
      run: cd android && ./gradlew assembleDebug

    - name: Run Unit Tests
      run: cd android && ./gradlew test

    - name: Upload Test Results
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: android-test-results
        path: android/app/build/reports/tests/
        retention-days: 7

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: android-debug-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
