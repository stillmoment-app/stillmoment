name: Coverage Comment

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage-comment:
    name: Post Coverage Report
    runs-on: macos-14
    if: github.event.workflow_run.event == 'pull_request' && github.event.workflow_run.conclusion == 'success'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Coverage Data
      uses: actions/download-artifact@v4
      with:
        name: coverage-data
        path: ./coverage-artifacts
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract Coverage Percentage
      id: coverage
      run: |
        if [ -d "./coverage-artifacts/TestResults.xcresult" ]; then
          COVERAGE=$(xcrun xccov view --report ./coverage-artifacts/TestResults.xcresult 2>/dev/null | \
            grep "Still Moment.app" | awk '{print $2}' | sed 's/%//' || echo "0")
          echo "percentage=${COVERAGE}" >> $GITHUB_OUTPUT
          echo "Found coverage: ${COVERAGE}%"
        else
          echo "percentage=0" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è No coverage data found"
        fi

    - name: Get PR Number
      id: pr
      run: |
        PR_NUMBER=$(jq -r '.pull_request.number' "$GITHUB_EVENT_PATH")
        echo "number=${PR_NUMBER}" >> $GITHUB_OUTPUT
        echo "PR Number: ${PR_NUMBER}"

    - name: Generate Coverage Report
      id: report
      run: |
        COVERAGE=${{ steps.coverage.outputs.percentage }}

        # Determine emoji and status
        if (( $(echo "$COVERAGE >= 90" | bc -l) )); then
          EMOJI="üéâ"
          STATUS="Excellent"
        elif (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          EMOJI="‚úÖ"
          STATUS="Good"
        elif (( $(echo "$COVERAGE >= 70" | bc -l) )); then
          EMOJI="‚ö†Ô∏è"
          STATUS="Needs Improvement"
        else
          EMOJI="‚ùå"
          STATUS="Critical"
        fi

        # Create detailed report
        cat > coverage-comment.md <<EOF
        ## ${EMOJI} Code Coverage Report

        **Overall Coverage:** ${COVERAGE}% (${STATUS})

        | Metric | Value | Status |
        |--------|-------|--------|
        | Coverage | ${COVERAGE}% | ${EMOJI} |
        | Threshold | 80% | $(if (( $(echo "$COVERAGE >= 80" | bc -l) )); then echo "‚úÖ Passed"; else echo "‚ùå Failed"; fi) |

        ### Coverage Guidelines
        - **90%+**: Excellent coverage üéâ
        - **80-89%**: Good coverage ‚úÖ
        - **70-79%**: Needs improvement ‚ö†Ô∏è
        - **<70%**: Critical - add more tests ‚ùå

        ### Top Files by Coverage
        EOF

        # Add top files from detailed coverage report
        if [ -d "./coverage-artifacts/TestResults.xcresult" ]; then
          xcrun xccov view --report ./coverage-artifacts/TestResults.xcresult 2>/dev/null | \
            grep -E "\.swift" | head -10 >> coverage-comment.md || echo "_(No detailed file data available)_" >> coverage-comment.md
        else
          echo "_(Coverage data not available)_" >> coverage-comment.md
        fi

        cat >> coverage-comment.md <<EOF

        ---
        *Generated by [Still Moment CI](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})*
        EOF

        cat coverage-comment.md

    - name: Post Coverage Comment
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const coverage = '${{ steps.coverage.outputs.percentage }}';
          const prNumber = '${{ steps.pr.outputs.number }}';

          if (!prNumber || prNumber === 'null') {
            console.log('No PR number found, skipping comment');
            return;
          }

          const reportContent = fs.readFileSync('coverage-comment.md', 'utf8');

          // Find existing coverage comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: prNumber,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Code Coverage Report')
          );

          const commentBody = reportContent;

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
            console.log('Updated existing coverage comment');
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });
            console.log('Created new coverage comment');
          }
